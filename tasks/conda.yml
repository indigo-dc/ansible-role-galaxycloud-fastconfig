---
- name: Enable Conda
  ini_file:
    dest: '{{ galaxy_config_file }}'
    section: '{{ item.section }}'
    option: '{{ item.option }}'
    value: '{{ item.value }}'
  with_items:
    - { section: 'app:main', option: 'conda_auto_install', value: "True" }
    - { section: 'app:main', option: 'conda_auto_init', value: "True" }
    #- { section: 'app:main', option: 'conda_ensure_channels', value: "{{ conda_channels }}" }

#- name: Change job working dir only when conda is enabled by default, to workaround current conda limitations
#  ini_file:
#    dest: '{{ galaxy_config_file }}'
#    section: 'app:main'
#    option: 'job_working_directory'
#    value: '{{ job_work_dir }}'
#  when: job_work_dir != 'database/jobs_directory' # job_work_dir is changed only if its value is different with resepct to the default one

- ini_file:
    dest: '{{ galaxy_config_file }}'
    section: 'app:main'
    option: 'conda_prefix'
    value: '{{ conda_prefix }}'

#______________________________________
# Install rsync
- name: '[EL] Install rsync'
  yum:
    name: '{{ item }}'
    state: present
  with_items:
    - rsync
  become_user: root
  become_method: sudo
  when: ansible_os_family == "RedHat"

- name: '[Ubuntu] Install rsync'
  apt:
    name: '{{ item }}'
    state: present
  with_items:
    - rsync
  become_user: root
  become_method: sudo
  when: ansible_os_family == "Debian"

#Â move conda packages to tool_deps/_conda/
- name: Move conda packages
  shell: 'rsync -av /home/galaxy/tool_deps {{tool_deps_path}} > /tmp/_conda_rsync.log'

# remove conda packages
- name: Remove old tool_deps
  file:
    dest: '/home/galaxy/tool_deps'
    state: absent
  become_user: root
  become_method: sudo
